<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" 
				xmlns:csxs="com.adobe.csxs.core.*"
				width="100%" height="100%" minWidth="250" minHeight="240"
				applicationComplete="onApplicationComplete()"
				backgroundColor="0x000000"
				historyManagementEnabled="false"
				horizontalScrollPolicy="off" layout="{ContainerLayout.ABSOLUTE}"
				usePreloader="false"
				>
	<mx:Script>
		<![CDATA[
			import com.adobe.csawlib.illustrator.Illustrator;
			import com.adobe.illustrator.*;
			
			import export.ExportOperation;
			
			import flash.filesystem.File;
			
			import managers.*;
			import managers.IllustratorController;
			
			import mx.collections.ArrayCollection;
			import mx.controls.ToolTip;
			import mx.controls.dataGridClasses.DataGridColumn;
			import mx.core.ContainerLayout;
			import mx.events.AIREvent;
			import mx.events.CollectionEvent;
			import mx.events.DataGridEvent;
			import mx.events.FlexEvent;
			import mx.events.ListEvent;
			import mx.managers.ToolTipManager;
			
			[Bindable]
			private var model:AppModel = null; 
			private var controller:AppController = null;
			
			private function onApplicationComplete():void{
				controller = AppController.getInstance();
				
				model = AppModel.getInstance();
				model.addEventListener("dataGridProviderChanged", dataGridProviderChangedHandler);
				
				ToolTipManager.showDelay = 1000;
				ToolTipManager.hideDelay = 10000;
				
				styleDeclaration.setStyle("backgroundColor", "0xFFFFFF");
			}
			
			protected function dataGridProviderChangedHandler (event:Event):void {
				gc.refresh();
				grid.expandAll();
			}
						
			protected function fileListDG_itemClickHandler(event:ListEvent):void
			{
//				saveButton.enabled = true; // todo: непонятно в каокй же момент кнопку делать активной
				controller.changeArtboardToComposition(controller.getAssetCompositionByIndex(event.rowIndex));
			}
			
			protected function fileListDG_itemDoubleClickHandler(event:ListEvent):void
			{
				controller.changeCompositionToIndex(event.rowIndex);
//				saveButton.enabled = true;// todo: непонятно в каокй же момент кнопку делать активной
			}
			
			protected function addNewAsset_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				controller.newFile();
				controller.changeCompositionToLastCreated();
			}
						
			public function hyphenate(item:Object, column:DataGridColumn):String {
				var title: String  = item[column.dataField].toString();
				if (column.width  < column.minWidth) {
					return "..."  + title.substr(-14);					
				} 
				return title;
				
			}
			
			public function selectSaveDir(event:*):void {
				try {
				var f:File = new File();
				f.browseForDirectory("Select directory to export your assets...");
				f.addEventListener(Event.SELECT, function(event:Event):void {
					model.defaultPathToPublish = f.nativePath;
				});
				} catch (e:Error) {
					trace('[Exception]' + e);					
				}
				
			}
			
			private var publishingOperation:ExportOperation;
			
			protected function publishButtonClick(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				publishingOperation = controller.export();
				exportProgress.source = publishingOperation;
				publishingOperation.publish();
			}
			
		]]>
	</mx:Script>
	
	<mx:Style source="assets/css/style.css"/>

	<mx:Box id="disabledView" width="100%" height="100%"
			visible="{!model || model.state == AppModel.STATE_DISABLED}" 
			includeInLayout="{this.visible}" 
			horizontalCenter="0" 
			verticalCenter="0">
		<mx:VBox left="40" top="100">
			<mx:Label text="Open document to start using Publisher"/>
		</mx:VBox>
	</mx:Box>
	
	<mx:Box id="welcomeView" width="100%" height="100%"
			visible="{model &amp;&amp; (model.state == AppModel.STATE_WELCOME)}" 
			includeInLayout="{this.visible}" 
			horizontalCenter="0" 
			verticalCenter="0">
		<mx:VBox left="40" top="100">
			<mx:Label text="Welcome!"/>
			<mx:Label text="Set up assets now to start working."/>
			<mx:Button label="Import artboards" click="model.setupDefault()"/>
		</mx:VBox>
	</mx:Box>
	

	
	<mx:VBox id="mainView" width="100%" height="100%"
			visible="{model &amp;&amp; (model.state == AppModel.STATE_NORMAL)}" 
			includeInLayout="{this.visible}">
		
		<mx:ProgressBar id="exportProgress" 
						width="100%" height="10" label="(%3%%) Published %1 files of %2" 
						mode="event"
						/>

		
		<mx:VBox width="100%" height="100%" verticalGap="3">
			<mx:AdvancedDataGrid id="grid" 
								 width="100%" height="100%"
								 dragEnabled="true"
								 dropEnabled="true"
								 dragMoveEnabled="true"
								 editable="true"
								 >
				<mx:dataProvider>
					<mx:GroupingCollection id="gc" source="{model.dataGridProvider}">
						<mx:grouping>
							<mx:Grouping>
								<mx:GroupingField name="pathToPublish" />
							</mx:Grouping>
						</mx:grouping>
					</mx:GroupingCollection>
				</mx:dataProvider>
				<mx:groupedColumns>   
					<mx:AdvancedDataGridColumn id="screenNameColumn" headerText="SCREENS ASSETS" dataField="name" />
					<mx:AdvancedDataGridColumn id="fileTypeColumn" editable="false" headerText="FILE TYPE" dataField="type" />
					<mx:AdvancedDataGridColumn id="dimensionColumn" editable="false" headerText="DIMENSION" dataField="dimensionsString" />
				</mx:groupedColumns>
			</mx:AdvancedDataGrid>
			
				<mx:HRule width="100%" shadowColor="0xCCCCCC" strokeColor="0x999999"/>
				
				<mx:HBox width="100%">
					<mx:Button label="..." click="selectSaveDir(event)"/>
				</mx:HBox>		
				
				<mx:HRule width="100%" shadowColor="0xCCCCCC" strokeColor="0x999999"/>
				
				<mx:HBox width="100%" horizontalGap="2" paddingBottom="1">
					<mx:Button width="80" height="16" label="Publish" click="publishButtonClick(event)"
							   toolTip="Publish assets"/>
					<mx:Spacer width="100%" />
					
					<mx:Button id="addNewAssetButton" 
						width="30" height="16" click="addNewAsset_clickHandler(event)"
							   disabledSkin="@Embed(source='assets/icons/new_disabled.png')"
							   downSkin="@Embed(source='assets/icons/new_down.png')"
							   overSkin="@Embed(source='assets/icons/new_over.png')" toolTip="New File"
							   upSkin="@Embed(source='assets/icons/new.png')"/>
					<mx:Spacer width="12" />
				</mx:HBox>
		</mx:VBox>
	</mx:VBox>
</mx:Application>