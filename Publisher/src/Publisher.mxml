<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" 
				xmlns:csxs="com.adobe.csxs.core.*"
				width="100%" height="100%" minWidth="250" minHeight="240"
				applicationComplete="onApplicationComplete()"
				historyManagementEnabled="false"
				horizontalScrollPolicy="off" layout="{ContainerLayout.ABSOLUTE}"
				usePreloader="false"
				>
	<mx:Script>
		<![CDATA[
			import com.adobe.csawlib.illustrator.Illustrator;
			import com.adobe.illustrator.*;
			
			import export.ExportOperation;
			
			import flash.filesystem.File;
			
			import managers.*;
			import managers.IllustratorController;
			
			import mx.collections.ArrayCollection;
			import mx.controls.ToolTip;
			import mx.core.ContainerLayout;
			import mx.events.AIREvent;
			import mx.events.CollectionEvent;
			import mx.events.DataGridEvent;
			import mx.events.FlexEvent;
			import mx.events.ListEvent;
			import mx.managers.ToolTipManager;
			
			[Bindable]
			private var model:AppModel = null; 
			private var controller:AppController = null;
			
			private function onApplicationComplete():void{
				model = AppModel.getInstance();
				model.dataGridProvider = dataGridProvider;

				formatNamesCB.selectedIndex = 2;
				controller = AppController.getInstance();
				
				ToolTipManager.showDelay = 1000;
				ToolTipManager.hideDelay = 10000;
				controller.fileListDG = fileListDG;
//				controller.documentActivated();		
				
				styleDeclaration.setStyle("backgroundColor", "0xFFFFFF");
			}
			
//			private function exportFileHandler(event:Event):void {
//				trace ("fileExport");
//				trace ("");
//				
//				(controller.appController as IllustratorController).app.redraw();
//				progressBox.width += 30;
//				progressBox.validateNow();
//				(controller.appController as IllustratorController).app.redraw();
//			}
			
			// Вызывается как-то часто по событию ValueCommit. 
			// Нужно апдейтить по изменению selectedIndex
			private function formatNamesCB_changeHandler(event:Event):void
			{
				model.formatName = formatNamesCB.selectedItem.label;				
			}
			
			protected function fileListDG_itemClickHandler(event:ListEvent):void
			{
				saveButton.enabled = true; // todo: непонятно в каокй же момент кнопку делать активной
				controller.changeArtboardToComposition(controller.getAssetCompositionByIndex(event.rowIndex));
			}
			
			protected function fileListDG_itemDoubleClickHandler(event:ListEvent):void
			{
				controller.changeCompositionToIndex(event.rowIndex);
				saveButton.enabled = true;// todo: непонятно в каокй же момент кнопку делать активной
			}
			
			protected function addNewAsset_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				controller.newFile();
				controller.changeCompositionToLastCreated();
				fileListDG.selectedIndex = model.dataGridProvider.length - 1;
				fileListDG.setFocus();
				fileListDG.editedItemPosition = {rowIndex:model.dataGridProvider.length - 1, columnIndex:1};
			}
			
			protected function fileListDG_itemFocusOutHandler(event:DataGridEvent):void
			{
				// TODO Auto-generated method stub
				//				controller.restoreComposition();
				saveButton.enabled = false;
			}
			
			public function hyphenate(item:Object, column:DataGridColumn):String {
				var title: String  = item[column.dataField].toString();
				if (column.width  < column.minWidth) {
					return "..."  + title.substr(-14);					
				} 
				return title;
				
			}
			
			protected function csxswindowedapplication1_focusOutHandler(event:FocusEvent):void
			{
				// TODO Auto-generated method stub
				saveButton.enabled = false;
				//				fileListDG.selectedIndex = -1;
			}
			
			protected function csxswindowedapplication1_applicationActivateHandler(event:AIREvent):void
			{
				// TODO Auto-generated method stub
				trace("activate");
			}
			
			protected function dataGridProvider_collectionChangeHandler(event:CollectionEvent):void
			{
				// TODO Auto-generated method stub
				if (!model) return;
				model.gridChanged();
				if (model.dataGridProvider) {
					fileListDG.validateNow();
					fileListDG.scrollToIndex(model.dataGridProvider.length);
				}
			}
			
			public function selectSaveDir(event:*):void {
				try {
				var f:File = new File();
				f.browseForDirectory("Select directory to export your assets...");
				f.addEventListener(Event.SELECT, function(event:Event):void {
					model.pathToPublish = f.nativePath;
				});
				} catch (e:Error) {
					trace('[Exception]' + e);					
				}
				
			}
			
			protected function pathInput_valueCommitHandler(event:FlexEvent):void
			{
				
				// TODO Auto-generated method stub
				model.pathToPublish = pathInput.text;
//				model.save(); //todo: если приложение закрывается, то не приводить к model.save
			}
			
			private var publishingOperation:ExportOperation;
			
			protected function publishButtonClick(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				publishingOperation = controller.export();
				exportProgress.source = publishingOperation;
				publishingOperation.publish(model.pathToPublish);
			}
			
		]]>
	</mx:Script>
	
	<mx:Style source="assets/css/style.css"/>

	<mx:Box id="welcomeView" width="100%" height="100%"
			visible="{model.state == 'welcome'}" 
			includeInLayout="{this.visible}" 
			horizontalCenter="0" 
			verticalCenter="0">
		<mx:VBox left="40" top="100">
			<mx:Label text="Welcome!"/>
			<mx:Label text="Set up assets now to start working."/>
			<mx:Button label="Import artboards" click="model.setupDefault()"/>
		</mx:VBox>
	</mx:Box>
	

	
	<mx:VBox id="mainView" width="100%" height="100%"
			visible="{model.state == 'normal'}" 
			includeInLayout="{this.visible}">
		
		<mx:ProgressBar id="exportProgress" 
						width="100%" height="10" label="(%3%%) Published %1 files of %2" 
						mode="event"
						/>

		
		<mx:VBox width="100%" height="100%" verticalGap="3">
			<mx:DataGrid id="fileListDG" 
						 width="100%" 
						 height="100%" 
						 backgroundAlpha="0.0"
						 borderStyle="none" 
						 doubleClickEnabled="true" 
						 editable="true"
						 itemClick="fileListDG_itemClickHandler(event)"
						 itemDoubleClick="fileListDG_itemDoubleClickHandler(event)"
						 itemFocusOut="fileListDG_itemFocusOutHandler(event)" 
						 resizableColumns="true"
						 rollOverColor="0xE0E0E0" 
						 rowCount="{model.dataGridProvider.length}"
						 selectionColor="0xC2D8ED" 
						 selectionDuration="0" 
						 showHeaders="true"
						 textSelectedColor="0x333333" 
						 verticalGridLineColor="0xB2B2B2"
						 verticalGridLines="false"
						 horizontalGridLines="false"
						 
						 allowMultipleSelection="true" 
						 dragEnabled="true" 
						 dropEnabled="true"
						 dragMoveEnabled="true"
						 sortableColumns="false"
						 >
				<mx:ArrayCollection id="dataGridProvider" collectionChange="dataGridProvider_collectionChangeHandler(event)"/>
				<mx:columns>
					<mx:DataGridColumn width="18" dataField="isPublished" editable="false" headerText="">
						<mx:itemRenderer> 
							<mx:Component> 
								<mx:Box paddingLeft="3">
									<mx:CheckBox borderColor="0xA0A0A0"
												 click="data.isPublished=!data.isPublished"
												 fillColors="0x000000 0xFFFFFF" 
												 highlightAlphas="0, 0"
												 selected="{data.isPublished}"/>
								</mx:Box>
							</mx:Component>                         
						</mx:itemRenderer> 
					</mx:DataGridColumn>
<!--					<mx:DataGridColumn dataField="artboardName" editable="false" headerText="Artboard"
									   labelFunction="hyphenate"/>-->
					<mx:DataGridColumn dataField="filename" dataTipField="filename" editable="true"
									   headerText="SCREENS"/>
					<mx:DataGridColumn dataField="fileType" dataTipField="fileType" editable="false"
									   headerText="FILE TYPE" width="60"
									   >
<!--						<mx:itemRenderer> 
							<mx:Component> 
								<mx:Box paddingLeft="3">
									<mx:Script>
										<![CDATA[
											import managers.PublishingItem;
											
											import mx.events.ListEvent;
											
											protected function combobox1_changeHandler(event:ListEvent):void
											{
												// TODO Auto-generated method stub
												(data as PublishingItem).fileType = combo.selectedItem.data; 
											}
											
										]]>
									</mx:Script>
									<mx:ComboBox id="combo" 
												 change="combobox1_changeHandler(event)" 
												 selectedIndex="{[PublishingItem.PNG24, PublishingItem.JPG].indexOf((data as PublishingItem).fileType)}">
										<mx:ArrayCollection>
											<mx:Object label="PNG 24" data="{PublishingItem.PNG24}" />
											<mx:Object label="JPEG" data="{PublishingItem.JPG}" />
										</mx:ArrayCollection>
									</mx:ComboBox>
								</mx:Box>
							</mx:Component>                         
						</mx:itemRenderer>--> 
						</mx:DataGridColumn>
					<mx:DataGridColumn dataField="dimensionsString" editable="false"
									   headerText="DIMENSIONS"
									   />
						<!--<mx:itemRenderer>
							<mx:Component>
								<mx:HBox width="100%" height="100%" borderColor="0xFF0000" borderStyle="solid" borderThickness="1">
									<mx:Script>
										<![CDATA[
											import managers.PublishingItem;
										]]>
									</mx:Script>
									<mx:Spacer width="0.1" />
									<mx:Label text="{(data as PublishingItem).dimensionsString}" />
									<mx:Box backgroundColor="0xFF0000" width="3" height="5" />
								</mx:HBox>								
							</mx:Component> 
						</mx:itemRenderer> 
					</mx:DataGridColumn>-->
				</mx:columns>
			</mx:DataGrid>
			
			
				
				<mx:HRule width="100%" shadowColor="0xCCCCCC" strokeColor="0x999999"/>
				
				<mx:HBox width="100%">
					<mx:TextInput id="pathInput" left="16" right="6" width="100%" height="20"
								  valueCommit="pathInput_valueCommitHandler(event)"
								  editable="true" fontSize="9"
								  text="{model.pathToPublish != null?model.pathToPublish:''}"
								  />
					<mx:Button label="..." click="selectSaveDir(event)"/>
					
					<mx:ComboBox id="formatNamesCB" visible="false" width="80"
								 change="formatNamesCB_changeHandler(event)"
								 dataProvider="{model.formatNames}" includeInLayout="false"
								 valueCommit="formatNamesCB_changeHandler(event)"/>			
					
				</mx:HBox>		
				
				<mx:HRule width="100%" shadowColor="0xCCCCCC" strokeColor="0x999999"/>
				
				<mx:HBox width="100%" horizontalGap="2" paddingBottom="1">
					<mx:Button width="80" height="16" label="Publish" click="publishButtonClick(event)"
							   toolTip="Publish assets"/>
					
					<mx:Button id="saveButton" width="80" height="16" label="Update"
							   click="controller.updateNthAssetWithCurrentComposition(fileListDG.selectedIndex)"
							   toolTip="Save current composition to selected asset"/>
					
					<mx:Spacer width="100%" />
					
					<mx:Button id="addNewAssetButton" 
						width="30" height="16" click="addNewAsset_clickHandler(event)"
							   disabledSkin="@Embed(source='assets/icons/new_disabled.png')"
							   downSkin="@Embed(source='assets/icons/new_down.png')"
							   overSkin="@Embed(source='assets/icons/new_over.png')" toolTip="New File"
							   upSkin="@Embed(source='assets/icons/new.png')"/>
					<mx:Button width="30" height="16"
							   click="controller.deleteSelectedFile(fileListDG.selectedItem, fileListDG.selectedIndex)"
							   disabledSkin="@Embed(source='assets/icons/delete_disabled.png')"
							   downSkin="@Embed(source='assets/icons/delete_down.png')"
							   enabled="{model.dataGridProvider.length &gt; 0}"
							   overSkin="@Embed(source='assets/icons/delete_over.png')"
							   toolTip="Delete File" upSkin="@Embed(source='assets/icons/delete.png')"/>
					
					<mx:Spacer width="12" />

					
				</mx:HBox>
			
		</mx:VBox>
		
		
	</mx:VBox>
	
</mx:Application>